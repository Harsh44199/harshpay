<%- include('../partials/header') %>

<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-paper-plane"></i> Send Money</h1>
        <p><i class="fas fa-info-circle"></i> Transfer money to any HarshPay user</p>
    </div>

    <% if (error) { %>
        <div class="alert alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <%= error %>
        </div>
    <% } %>
    <% if (success) { %>
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <%= success %>
        </div>
    <% } %>

    <div class="form-card">
        <form action="/payment/send" method="POST" id="sendMoneyForm">
            <div class="form-group">
                <label for="receiver_email">
                    <i class="fas fa-user"></i>
                    Recipient Email
                </label>
                <input type="email" 
                       id="receiver_email" 
                       name="receiver_email" 
                       required 
                       placeholder="Enter recipient's email"
                       autocomplete="off">
                <div id="userSuggestions" class="suggestions-dropdown"></div>
            </div>

            <div class="form-group">
                <label for="amount">
                    <i class="fas fa-rupee-sign"></i>
                    Amount (₹)
                </label>
                <input type="number" 
                       id="amount" 
                       name="amount" 
                       required 
                       min="1" 
                       step="0.01" 
                       placeholder="Enter amount">
                <p class="form-help">
                    <i class="fas fa-wallet"></i>
                    Available balance: ₹<%= parseFloat(user.balance).toFixed(2) %>
                </p>
            </div>

            <div class="form-group">
                <label for="description">
                    <i class="fas fa-comment"></i>
                    Description (Optional)
                </label>
                <textarea id="description" 
                          name="description" 
                          rows="3" 
                          placeholder="Add a note..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-paper-plane"></i>
                Send Money
            </button>
        </form>
    </div>
</div>

<script>
let searchTimeout;
const emailInput = document.getElementById('receiver_email');
const suggestionsDiv = document.getElementById('userSuggestions');

emailInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 3) {
        suggestionsDiv.innerHTML = '';
        suggestionsDiv.style.display = 'none';
        return;
    }

    searchTimeout = setTimeout(() => {
        fetch(`/search-users?email=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(users => {
                if (users.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item">No users found</div>';
                } else {
                    suggestionsDiv.innerHTML = users.map(user => `
                        <div class="suggestion-item" onclick="selectUser('${user.email}', '${user.full_name}')">
                            <div>
                                <strong>${user.full_name}</strong><br>
                                <small>${user.email}</small>
                            </div>
                        </div>
                    `).join('');
                }
                suggestionsDiv.style.display = 'block';
            })
            .catch(err => console.error('Search error:', err));
    }, 300);
});

function selectUser(email, name) {
    emailInput.value = email;
    suggestionsDiv.innerHTML = '';
    suggestionsDiv.style.display = 'none';
}

document.addEventListener('click', function(e) {
    if (e.target !== emailInput && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
    }
});
</script>

<%- include('../partials/footer') %>