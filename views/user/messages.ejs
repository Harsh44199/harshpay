<%- include('../partials/header') %>

<div class="messages-container">
    <div class="messages-layout">
        
        <!-- Sidebar - Conversations List -->
        <div class="conversations-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-comments"></i> Messages</h2>
                <a href="/messages/new" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus"></i> New
                </a>
            </div>

            <% if (conversations && conversations.length > 0) { %>
                <div class="conversations-list">
                    <% conversations.forEach(function(conv) { %>
                        <a href="/messages/<%= conv.other_user_id %>" 
                           class="conversation-item <%= selectedUser && selectedUser.id == conv.other_user_id ? 'active' : '' %>">
                            <div class="conversation-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="conversation-info">
                                <div class="conversation-name">
                                    <%= conv.other_user_name %>
                                    <% if (conv.unread_count > 0) { %>
                                        <span class="unread-badge"><%= conv.unread_count %></span>
                                    <% } %>
                                </div>
                                <div class="conversation-preview">
                                    <%= conv.last_message ? conv.last_message.substring(0, 50) : 'Start conversation' %><%= conv.last_message && conv.last_message.length > 50 ? '...' : '' %>
                                </div>
                                <div class="conversation-time">
                                    <%= new Date(conv.last_message_time).toLocaleDateString() %>
                                </div>
                            </div>
                        </a>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="empty-conversations">
                    <i class="fas fa-inbox"></i>
                    <p>No conversations yet</p>
                    <a href="/messages/new" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Start Messaging
                    </a>
                </div>
            <% } %>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-area">
            <% if (selectedUser) { %>
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-user-info">
                        <i class="fas fa-user-circle"></i>
                        <div>
                            <strong><%= selectedUser.full_name %></strong>
                            <span><%= selectedUser.email %></span>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div class="messages-area" id="messagesArea">
                    <% if (messages && messages.length > 0) { %>
                        <% messages.forEach(function(msg) { %>
                            <div class="message <%= msg.sender_id == user.id ? 'sent' : 'received' %>" data-id="<%= msg.id %>">
                                <div class="message-content">
                                    <%= msg.message %>
                                </div>
                                <div class="message-time">
                                    <%= new Date(msg.created_at).toLocaleTimeString() %>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-messages">
                            <i class="fas fa-comments"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    <% } %>
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <form id="messageForm" onsubmit="return false;">
                        <input type="hidden" id="receiverId" value="<%= selectedUser.id %>">
                        <input type="text" 
                               id="messageInput" 
                               placeholder="Type your message..." 
                               autocomplete="off"
                               required>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </form>
                </div>
            <% } else { %>
                <!-- No Conversation Selected -->
                <div class="no-conversation-selected">
                    <i class="fas fa-comments"></i>
                    <h3>Select a conversation</h3>
                    <p>Choose a conversation from the sidebar or start a new one</p>
                    <a href="/messages/new" class="btn btn-primary">
                        <i class="fas fa-plus"></i> New Conversation
                    </a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<% if (selectedUser) { %>
<script>
var messageForm = document.getElementById('messageForm');
var messageInput = document.getElementById('messageInput');
var messagesArea = document.getElementById('messagesArea');
var sendButton = document.getElementById('sendButton');
var receiverId = parseInt(document.getElementById('receiverId').value);
var currentUserId = <%= user.id %>;
var lastMessageId = <%= messages && messages.length > 0 ? messages[messages.length - 1].id : 0 %>;
var pollInterval;

// Mobile: Show chat area and hide sidebar
if (window.innerWidth <= 768) {
    document.querySelector('.chat-area').classList.add('show-mobile');
    var sidebar = document.querySelector('.conversations-sidebar');
    if (sidebar) {
        sidebar.classList.add('hide-mobile');
    }
}

// Mobile: Back button functionality
var chatHeader = document.querySelector('.chat-header');
if (chatHeader && window.innerWidth <= 768) {
    chatHeader.addEventListener('click', function(e) {
        if (e.target === chatHeader || e.target.tagName === 'I') {
            window.location.href = '/messages';
        }
    });
    chatHeader.style.cursor = 'pointer';
}

messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    var message = messageInput.value.trim();
    if (!message) return;
    
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch('/messages/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receiver_id: receiverId, message: message })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            addMessageToUI(data.message, true);
            messageInput.value = '';
            lastMessageId = data.message.id;
            scrollToBottom();
        } else {
            alert('Failed to send message');
        }
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
    })
    .catch(function(error) {
        console.error('Send error:', error);
        alert('Failed to send message');
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
    });
});

function startPolling() {
    pollInterval = setInterval(function() {
        fetch('/messages/poll/' + receiverId + '?lastMessageId=' + lastMessageId)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success && data.messages && data.messages.length > 0) {
                data.messages.forEach(function(msg) {
                    addMessageToUI(msg, false);
                    lastMessageId = msg.id;
                });
                scrollToBottom();
            }
        })
        .catch(function(error) {
            console.error('Poll error:', error);
        });
    }, 3000);
}

function addMessageToUI(message, isSent) {
    var existing = document.querySelector('[data-id="' + message.id + '"]');
    if (existing) return;
    
    var noMessages = messagesArea.querySelector('.no-messages');
    if (noMessages) noMessages.remove();
    
    var messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + (isSent ? 'sent' : 'received');
    messageDiv.setAttribute('data-id', message.id);
    
    var contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.textContent = message.message;
    
    var timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = new Date(message.created_at).toLocaleTimeString();
    
    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(timeDiv);
    messagesArea.appendChild(messageDiv);
}

function scrollToBottom() {
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

startPolling();
scrollToBottom();
messageInput.focus();

window.addEventListener('beforeunload', function() {
    if (pollInterval) clearInterval(pollInterval);
});

// Handle window resize
window.addEventListener('resize', function() {
    scrollToBottom();
});
</script>
<% } %>

<%- include('../partials/footer') %>